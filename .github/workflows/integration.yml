name: Integration Tests

on:
  release:
    types: [published]
  workflow_dispatch:
  workflow_call:
    secrets:
      OPENAI_API_KEY:
        required: true
      ANTHROPIC_API_KEY:
        required: false
      GOOGLE_API_KEY:
        required: false
      XAI_API_KEY:
        required: false
      AWS_ACCESS_KEY_ID:
        required: false
      AWS_SECRET_ACCESS_KEY:
        required: false

jobs:
  integration-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      MEMORI_TEST_MODE: "1"
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
      XAI_API_KEY: ${{ secrets.XAI_API_KEY }}
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_REGION: us-east-1

    steps:
      - uses: actions/checkout@v5

      - name: Install uv
        uses: astral-sh/setup-uv@v7

      - name: Set up Python
        run: uv python install 3.12

      - name: Install dependencies
        run: |
          uv sync --dev
          uv pip install google-genai langchain-aws || true

      - name: Run AA Payload Unit Tests (no API keys needed)
        run: |
          echo "Running AA payload unit tests..."
          uv run pytest tests/memory/augmentation/test_aa_payload_unit.py -v --tb=short

      - name: Run AA Integration Tests (staging API)
        if: env.OPENAI_API_KEY != ''
        run: |
          echo "Running AA integration tests against staging..."
          uv run pytest tests/integration/test_aa_payload.py -v -m integration --tb=short

      - name: Run OpenAI Integration Tests
        if: env.OPENAI_API_KEY != ''
        run: |
          echo "Running OpenAI integration tests..."
          uv run pytest tests/integration/providers/test_openai.py -v -m integration --tb=short

      - name: Run Anthropic Integration Tests
        if: env.ANTHROPIC_API_KEY != ''
        run: |
          echo "Running Anthropic integration tests..."
          uv run pytest tests/integration/providers/test_anthropic.py -v -m integration --tb=short

      - name: Run Google Integration Tests
        if: env.GOOGLE_API_KEY != ''
        run: |
          echo "Running Google integration tests..."
          uv run pytest tests/integration/providers/test_google.py -v -m integration --tb=short

      - name: Run xAI Integration Tests
        if: env.XAI_API_KEY != ''
        run: |
          echo "Running xAI integration tests..."
          uv run pytest tests/integration/providers/test_xai.py -v -m integration --tb=short

      - name: Run Bedrock Integration Tests
        if: env.AWS_ACCESS_KEY_ID != '' && env.AWS_SECRET_ACCESS_KEY != ''
        run: |
          echo "Running Bedrock integration tests..."
          uv run pytest tests/integration/providers/test_bedrock.py -v -m integration --tb=short

      - name: Integration Test Summary
        if: always()
        run: |
          echo "=========================================="
          echo "Integration Test Summary"
          echo "=========================================="
          echo "MEMORI_TEST_MODE: $MEMORI_TEST_MODE (staging)"
          echo ""
          echo "Tests run:"
          echo "  - AA Payload Unit Tests: Yes (no API keys needed)"
          if [ -n "$OPENAI_API_KEY" ]; then echo "  - AA Integration Tests: Yes"; else echo "  - AA Integration Tests: Skipped (no key)"; fi
          echo ""
          echo "Providers tested:"
          if [ -n "$OPENAI_API_KEY" ]; then echo "  - OpenAI: Yes"; else echo "  - OpenAI: Skipped (no key)"; fi
          if [ -n "$ANTHROPIC_API_KEY" ]; then echo "  - Anthropic: Yes"; else echo "  - Anthropic: Skipped (no key)"; fi
          if [ -n "$GOOGLE_API_KEY" ]; then echo "  - Google: Yes"; else echo "  - Google: Skipped (no key)"; fi
          if [ -n "$XAI_API_KEY" ]; then echo "  - xAI: Yes"; else echo "  - xAI: Skipped (no key)"; fi
          if [ -n "$AWS_ACCESS_KEY_ID" ]; then echo "  - Bedrock: Yes"; else echo "  - Bedrock: Skipped (no key)"; fi
          echo "=========================================="

  integration-complete:
    runs-on: ubuntu-latest
    needs: integration-tests
    if: always()
    steps:
      - name: Check integration test results
        run: |
          if [ "${{ needs.integration-tests.result }}" == "success" ]; then
            echo "All integration tests passed!"
            exit 0
          else
            echo "Integration tests failed!"
            exit 1
          fi
